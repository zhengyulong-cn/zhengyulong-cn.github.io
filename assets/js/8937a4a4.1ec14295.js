"use strict";(self.webpackChunkprivate_long_blog=self.webpackChunkprivate_long_blog||[]).push([[6018],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>k});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),p=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(i.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(n),m=a,k=d["".concat(i,".").concat(m)]||d[m]||u[m]||l;return n?r.createElement(k,o(o({ref:t},c),{},{components:n})):r.createElement(k,o({ref:t},c))}));function k(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,o=new Array(l);o[0]=m;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s[d]="string"==typeof e?e:a,o[1]=s;for(var p=2;p<l;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},8961:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));const l={},o="Nestjs\u5165\u95e8\u2014\u2014\u57fa\u672c\u539f\u5219",s={unversionedId:"frontend-programing-skills/Node\u4ece\u5165\u95e8\u5230\u7cbe\u901a/Nestjs\u5165\u95e8\u2014\u2014\u57fa\u672c\u539f\u5219",id:"frontend-programing-skills/Node\u4ece\u5165\u95e8\u5230\u7cbe\u901a/Nestjs\u5165\u95e8\u2014\u2014\u57fa\u672c\u539f\u5219",title:"Nestjs\u5165\u95e8\u2014\u2014\u57fa\u672c\u539f\u5219",description:"\u81ea\u5b9a\u4e49Provider",source:"@site/docs/frontend-programing-skills/Node\u4ece\u5165\u95e8\u5230\u7cbe\u901a/Nestjs\u5165\u95e8\u2014\u2014\u57fa\u672c\u539f\u5219.md",sourceDirName:"frontend-programing-skills/Node\u4ece\u5165\u95e8\u5230\u7cbe\u901a",slug:"/frontend-programing-skills/Node\u4ece\u5165\u95e8\u5230\u7cbe\u901a/Nestjs\u5165\u95e8\u2014\u2014\u57fa\u672c\u539f\u5219",permalink:"/docs/frontend-programing-skills/Node\u4ece\u5165\u95e8\u5230\u7cbe\u901a/Nestjs\u5165\u95e8\u2014\u2014\u57fa\u672c\u539f\u5219",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"frontend-programing-skills",previous:{title:"Nestjs\u5165\u95e8\u2014\u2014\u57fa\u672c\u4f7f\u7528",permalink:"/docs/frontend-programing-skills/Node\u4ece\u5165\u95e8\u5230\u7cbe\u901a/Nestjs\u5165\u95e8\u2014\u2014\u57fa\u672c\u4f7f\u7528"},next:{title:"Nestjs\u5165\u95e8\u2014\u2014\u5468\u8fb9\u6280\u672f",permalink:"/docs/frontend-programing-skills/Node\u4ece\u5165\u95e8\u5230\u7cbe\u901a/Nestjs\u5165\u95e8\u2014\u2014\u5468\u8fb9\u6280\u672f"}},i={},p=[{value:"\u81ea\u5b9a\u4e49Provider",id:"\u81ea\u5b9a\u4e49provider",level:2},{value:"\u4f9d\u8d56\u6ce8\u5165\u7684\u57fa\u672c\u6d41\u7a0b",id:"\u4f9d\u8d56\u6ce8\u5165\u7684\u57fa\u672c\u6d41\u7a0b",level:3},{value:"useValue",id:"usevalue",level:3},{value:"\u975e\u7c7bProvider",id:"\u975e\u7c7bprovider",level:3},{value:"useClass",id:"useclass",level:3},{value:"useFactory",id:"usefactory",level:3},{value:"useExisting",id:"useexisting",level:3},{value:"\u975e\u670d\u52a1\u578bProvider",id:"\u975e\u670d\u52a1\u578bprovider",level:3},{value:"\u5bfc\u51fa\u81ea\u5b9a\u4e49Provider",id:"\u5bfc\u51fa\u81ea\u5b9a\u4e49provider",level:3},{value:"\u5f02\u6b65Provider",id:"\u5f02\u6b65provider",level:3},{value:"\u52a8\u6001\u6a21\u5757",id:"\u52a8\u6001\u6a21\u5757",level:2},{value:"\u6ce8\u5165\u4f5c\u7528\u57df",id:"\u6ce8\u5165\u4f5c\u7528\u57df",level:2},{value:"Provider\u8303\u56f4",id:"provider\u8303\u56f4",level:3},{value:"Controller\u8303\u56f4",id:"controller\u8303\u56f4",level:3},{value:"\u5faa\u73af\u4f9d\u8d56",id:"\u5faa\u73af\u4f9d\u8d56",level:2},{value:"\u524d\u5411\u5f15\u7528",id:"\u524d\u5411\u5f15\u7528",level:3},{value:"\u4f7f\u7528ModuleRef\u7c7b",id:"\u4f7f\u7528moduleref\u7c7b",level:3},{value:"\u6a21\u5757\u5f15\u7528",id:"\u6a21\u5757\u5f15\u7528",level:2},{value:"ModuleRef\u57fa\u672c\u4f7f\u7528",id:"moduleref\u57fa\u672c\u4f7f\u7528",level:3},{value:"\u6ce8\u518cREQUEST Provider",id:"\u6ce8\u518crequest-provider",level:3},{value:"\u83b7\u53d6\u5f53\u524d\u5b50\u6811",id:"\u83b7\u53d6\u5f53\u524d\u5b50\u6811",level:3},{value:"\u52a8\u6001\u5b9e\u4f8b\u5316\u81ea\u5b9a\u4e49\u7c7b",id:"\u52a8\u6001\u5b9e\u4f8b\u5316\u81ea\u5b9a\u4e49\u7c7b",level:3},{value:"\u6a21\u5757\u61d2\u52a0\u8f7d",id:"\u6a21\u5757\u61d2\u52a0\u8f7d",level:2},{value:"\u6267\u884c\u4e0a\u4e0b\u6587",id:"\u6267\u884c\u4e0a\u4e0b\u6587",level:2},{value:"ArgumentsHost",id:"argumentshost",level:3},{value:"ExecutionContext",id:"executioncontext",level:3},{value:"\u53cd\u5c04\u548c\u5143\u6570\u636e",id:"\u53cd\u5c04\u548c\u5143\u6570\u636e",level:3},{value:"\u751f\u547d\u5468\u671f\u4e8b\u4ef6",id:"\u751f\u547d\u5468\u671f\u4e8b\u4ef6",level:2},{value:"\u6267\u884c\u987a\u5e8f",id:"\u6267\u884c\u987a\u5e8f",level:3},{value:"\u4f7f\u7528",id:"\u4f7f\u7528",level:3}],c={toc:p},d="wrapper";function u(e){let{components:t,...l}=e;return(0,a.kt)(d,(0,r.Z)({},c,l,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"nestjs\u5165\u95e8\u57fa\u672c\u539f\u5219"},"Nestjs\u5165\u95e8\u2014\u2014\u57fa\u672c\u539f\u5219"),(0,a.kt)("h2",{id:"\u81ea\u5b9a\u4e49provider"},"\u81ea\u5b9a\u4e49Provider"),(0,a.kt)("h3",{id:"\u4f9d\u8d56\u6ce8\u5165\u7684\u57fa\u672c\u6d41\u7a0b"},"\u4f9d\u8d56\u6ce8\u5165\u7684\u57fa\u672c\u6d41\u7a0b"),(0,a.kt)("p",null,"\u4f9d\u8d56\u6ce8\u5165\u662f\u4e00\u79cd\u63a7\u5236\u7ffb\u8f6c\uff08IOC\uff09\u6280\u672f\uff0c\u53ef\u4ee5\u5c06\u4f9d\u8d56\u7684\u5b9e\u4f8b\u59d4\u6d3e\u7ed9IOC\u5bb9\u5668\uff0c\u800c\u4e0d\u662f\u5fc5\u987b\u5728\u81ea\u5df1\u4ee3\u7801\u4e2d\u6267\u884c\u3002"),(0,a.kt)("p",null,"\u5206\u4e3a\u4e09\u6b65\uff1a"),(0,a.kt)("p",null,"1.\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"cats.service.ts"),"\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"@Injectable()"),"\u58f0\u660eCatsService\u7c7b\uff0c\u7531IOC\u5bb9\u5668\u7ba1\u7406\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class CatsService {\n  private readonly cats: Array<ICat> = [];\n  findAll(): Array<ICat> {\n    return this.cats;\n  }\n}\n")),(0,a.kt)("p",null,"2.\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"cats.controller.ts"),"\u4e2dCatsController\u58f0\u660e\u4f9d\u8d56\u4e8eService\u4ee4\u724c\u7684\u6784\u9020\u51fd\u6570\u6ce8\u5165\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Controller('cats')\nexport class CatsController {\n  constructor(private readonly catsService: CatsService) {}\n  @Get()\n  async findAll(): Promise<Array<ICat>> {\n    return this.catsService.findAll();\n  }\n}\n")),(0,a.kt)("p",null,"3.\u5728",(0,a.kt)("inlineCode",{parentName:"p"},"app.module.ts"),"\u4e2d\uff0c\u5c06\u6807\u8bb0\u7684CatsService\u548c",(0,a.kt)("inlineCode",{parentName:"p"},"cats.service.ts"),"\u6587\u4ef6\u4e2d\u7684CatsService\u7c7b\u76f8\u5173\u8054\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Module({\n  controllers: [CatsController],\n  providers: [CatsService],\n})\nexport class AppModule {}\n")),(0,a.kt)("p",null,"\u5f53IOC\u5bb9\u5668\u5b9e\u4f8b\u5316CatsController\u65f6\uff0c\u4f1a\u9996\u5148\u67e5\u627e\u6240\u6709\u4f9d\u8d56\u9879\uff0c\u5f53\u67e5\u627e\u5230CatsService\u4f9d\u8d56\u9879\u65f6\uff0c\u4f1a\u5bf9\u5176\u4ee4\u724c\u6267\u884c\u67e5\u627e\u5e76\u8fd4\u56deCatsService\u7c7b\u3002\u5982\u679c\u662f\u9ed8\u8ba4\u7684\u5355\u4f8b\u8303\u56f4\uff0cNest.js\u5c06\u521b\u5efaCatsService\u5b9e\u4f8b\uff0c\u5c06\u5176\u7f13\u5b58\u5e76\u8fd4\u56de\uff0c\u6216\u8fd4\u56de\u73b0\u6709\u7684\u7f13\u5b58\u5b9e\u4f8b\u3002"),(0,a.kt)("p",null,"::: tip\n",(0,a.kt)("inlineCode",{parentName:"p"},"providers: [CatsService]"),"\u662f\u5982\u4e0b\u4ee3\u7801\u7684\u7b80\u5199\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"providers: [\n  {\n    // \u4ee4\u724c\n    provide: CatsService,\n    // \u7c7b\n    useClass: CatsService,\n  },\n];\n")),(0,a.kt)("p",null,":::"),(0,a.kt)("h3",{id:"usevalue"},"useValue"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"useValue"),"\u8bed\u6cd5\u5bf9\u4e8e\u6ce8\u5165\u5e38\u91cf\u503c\u3001\u5916\u90e8\u5e93\u3001\u6a21\u62df\u5bf9\u8c61\u65f6\u975e\u5e38\u6709\u7528\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"import { CatsService } from './cats.service';\nconst mockCatsService = {\n  findAllx: () => [\n    { name: 'Kitty', age: 20, breed: 'A' },\n    { name: 'Whiskers', age: 18, breed: 'AB' },\n  ],\n};\n@Module({\n  imports: [CatsModule],\n  providers: [\n    {\n      provide: CatsService,\n      useValue: mockCatsService,\n    },\n  ],\n})\nexport class AppModule {}\n")),(0,a.kt)("p",null,"::: danger\n\u6ce8\u610f\uff1a",(0,a.kt)("inlineCode",{parentName:"p"},"useValue"),"\u4e0e\u8981\u66ff\u6362\u7684CatsService\u7c7b\u8981\u5177\u6709\u76f8\u540c\u7684\u63a5\u53e3\n:::"),(0,a.kt)("h3",{id:"\u975e\u7c7bprovider"},"\u975e\u7c7bProvider"),(0,a.kt)("p",null,"\u5728\u4e4b\u524d\u7684\u7ae0\u8282\u4e2d\uff0c\u5168\u5c40\u7684\u8fc7\u6ee4\u5668\u3001\u7ba1\u9053\u3001\u5b88\u536b\u90fd\u80fd\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"APP_*"),"\u6765\u6807\u8bb0Provider\u7684\u4ee4\u724c\uff0c\u8fd9\u662f\u5b57\u7b26\u4e32\uff0c\u4e0d\u662f\u4e00\u4e2a\u7c7b\u3002"),(0,a.kt)("p",null,"\u6bd4\u5982\u81ea\u5b9a\u4e49\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"'CONNECTION'"),"\u4f5c\u4ee4\u724c\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Module({\n  providers: [\n    {\n      provide: 'CONNECTION',\n      useValue: connection,\n    },\n  ],\n})\nexport class AppModule {}\n")),(0,a.kt)("p",null,"\u4f7f\u7528\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class CatsRepository {\n  // @Inject\u88c5\u9970\u5668\u53ea\u63a5\u53d7\u4ee4\u724c\u8fd9\u4e00\u4e2a\u53c2\u6570\n  constructor(@Inject('CONNECTION') connection: Connection) {}\n}\n")),(0,a.kt)("p",null,"::: tip\n\u4e3a\u4e86\u4ee3\u7801\u7ec4\u7ec7\u6e05\u6670\uff0c\u6700\u4f73\u5b9e\u8df5\u5e94\u8be5\u662f\u5c06\u4ee4\u724c\u653e\u5728\u5355\u72ec\u6587\u4ef6\u4e2d\u5b9a\u4e49\u3002\n:::"),(0,a.kt)("h3",{id:"useclass"},"useClass"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Module({\n  providers: [\n    {\n      provide: ConfigService,\n      useClass: process.env.NODE_ENV === 'development' ? DevelopmentConfigService : ProductionConfigService,\n    }\n  ],\n})\nexport class AppModule {}\n")),(0,a.kt)("p",null,"\u4f7f\u7528ConfigService\u7c7b\u540d\u79f0\u4f5c\u4e3a\u4ee4\u724c\uff0c\u5bf9\u4e8e\u4efb\u4f55\u4f9d\u8d56ConfigService\u7684\u7c7b\uff0cNest.js\u90fd\u4f1a\u6ce8\u5165\u63d0\u4f9b\u7684\u7c7b\u7684\u5b9e\u4f8b\uff08DevelopmentConfigService\u6216ProductionConfigService\uff09\u3002"),(0,a.kt)("p",null,"\u6ce8\u610f\u8fd9\u91cc\u662f\u4f9d\u8d56\u4e8eConfigService\u7c7b\uff0c\u6ce8\u5165\u7684\u4e0d\u662fConfigService\u5b9e\u4f8b\uff0c\u800c\u662f",(0,a.kt)("inlineCode",{parentName:"p"},"useClass"),"\u540e\u8ddf\u7740\u7684\u7c7b\u7684\u5b9e\u4f8b\u3002"),(0,a.kt)("h3",{id:"usefactory"},"useFactory"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"useFactory"),"\u5141\u8bb8\u52a8\u6001\u521b\u5efa\u63d0\u4f9b\u7a0b\u5e8f\uff0c\u5b9e\u5de5\u5382\u51fd\u6570\u8fd4\u56de\u5b9e\u9645\u7684Provider\uff0c\u5de5\u5382\u53ef\u4ee5\u6ce8\u5165\u5176\u4ed6Provider\u6765\u8ba1\u7b97\u7ed3\u679c\uff0c\u4e0d\u8fc7\u6709\u4e00\u4e9b\u9650\u5236\uff1a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u5de5\u5382\u51fd\u6570\u53ef\u4ee5\u63a5\u6536\u53c2\u6570\u3002"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"inject"),"\u5c5e\u6027\u63a5\u6536\u4e00\u4e2aProvider\u6570\u7ec4\uff0c\u5728\u5b9e\u4f8b\u5316\u8fc7\u7a0b\u4e2d\uff0cNest.js\u5c06\u89e3\u6790\u8be5\u6570\u7ec4\u5e76\u5c06\u5176\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u5de5\u5382\u51fd\u6570\u3002")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const connectionFactory = {\n  provide: 'CONNECTION',\n  // useFactory\u4e2d\u53ef\u4ee5\u83b7\u53d6\u5230OptionsProvider\n  useFactory: (optionsProvider: OptionsProvider) => {\n    const options = optionsProvider.get();\n    return new DatabaseConnection(options);\n  },\n  inject: [OptionsProvider],\n};\n\n@Module({\n  providers: [connectionFactory],\n})\nexport class AppModule {}\n")),(0,a.kt)("h3",{id:"useexisting"},"useExisting"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"useExisting"),"\u5141\u8bb8\u4e3a\u73b0\u6709\u7684\u63d0\u4f9b\u7a0b\u5e8f\u521b\u5efa\u522b\u540d\uff0c\u8fd9\u5c06\u521b\u5efa\u4e24\u79cd\u8bbf\u95ee\u540c\u4e00Provider\u7684\u65b9\u6cd5\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nclass LoggerService {\n  /* implementation details */\n}\n// AliasedLoggerService\u662fLoggerService\u7684\u522b\u540d\nconst loggerAliasProvider = {\n  provide: 'AliasedLoggerService',\n  useExisting: LoggerService,\n};\n\n@Module({\n  // \u89e3\u6790\u4e3a\u540c\u4e00\u4e2a\u5b9e\u4f8b\n  providers: [LoggerService, loggerAliasProvider],\n})\nexport class AppModule {}\n")),(0,a.kt)("h3",{id:"\u975e\u670d\u52a1\u578bprovider"},"\u975e\u670d\u52a1\u578bProvider"),(0,a.kt)("p",null,"\u867d\u7136Provider\u7ecf\u5e38\u63d0\u4f9b\u670d\u52a1\uff0c\u4f46\u5e76\u4e0d\u4ec5\u9650\u8fd9\u79cd\u7528\u9014\uff0cProvider\u53ef\u4ee5\u63d0\u4f9b\u4efb\u4f55\u503c\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const configFactory = {\n  provide: 'CONFIG',\n  // \u6839\u636e\u73af\u5883\u63d0\u4f9b\u914d\u7f6e\u5bf9\u8c61\u6570\u7ec4\n  useFactory: () => (process.env.NODE_ENV === 'development' ? devConfig : prodConfig),\n};\n@Module({\n  providers: [configFactory],\n})\nexport class AppModule {}\n")),(0,a.kt)("h3",{id:"\u5bfc\u51fa\u81ea\u5b9a\u4e49provider"},"\u5bfc\u51fa\u81ea\u5b9a\u4e49Provider"),(0,a.kt)("p",null,"1.\u5bfc\u51fa\u4ee4\u724c"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Module({\n  providers: [configFactory],\n  exports: ['CONFIG'],\n})\nexport class AppModule {}\n")),(0,a.kt)("p",null,"2.\u5bfc\u51fa\u6574\u4e2a\u5bf9\u8c61"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Module({\n  providers: [configFactory],\n  exports: [configFactory],\n})\nexport class AppModule {}\n")),(0,a.kt)("h3",{id:"\u5f02\u6b65provider"},"\u5f02\u6b65Provider"),(0,a.kt)("p",null,"\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"useFactory"),"\u8bed\u6cd5\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"async/await"),"\uff0c\u5de5\u5382\u51fd\u6570\u53ef\u4ee5\u7b49\u5f85\u5f02\u6b65\u4efb\u52a1\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const asyncConnectionFactory ={\n  provide: 'ASYNC_CONNECTION',\n  useFactory: async () => {\n    const connection = await createConnection(options);\n    return connection;\n  },\n}\n")),(0,a.kt)("p",null,"\u6700\u7ec8\u901a\u8fc7",(0,a.kt)("inlineCode",{parentName:"p"},"@Inject('ASYNC_CONNECTION)"),"\u6ce8\u5165\u5230\u5176\u4ed6\u7ec4\u4ef6\u4e2d\u3002"),(0,a.kt)("h2",{id:"\u52a8\u6001\u6a21\u5757"},"\u52a8\u6001\u6a21\u5757"),(0,a.kt)("p",null,"\u5982\u679c\u60f3\u52a8\u6001\u5bfc\u5165\u6a21\u5757\uff0c\u53ef\u4ee5\u50cf\u5982\u4e0b\u8fd9\u6837\u5199\uff1a"),(0,a.kt)("p",null,"\u901a\u8fc7",(0,a.kt)("inlineCode",{parentName:"p"},"register()"),"\u65b9\u6cd5\u8fd4\u56de\u7684\u662f\u52a8\u6001\u6a21\u5757\uff0c\u5373\u5728\u8fd0\u884c\u65f6\u521b\u5efa\u7684\u6a21\u5757\u3002\u52a8\u6001\u6a21\u5757\u5fc5\u987b\u8fd4\u56de\u5177\u6709\u5b8c\u5168\u76f8\u540c\u63a5\u53e3\u7684\u5bf9\u8c61\uff0c\u5916\u52a0\u4e00\u4e2a",(0,a.kt)("inlineCode",{parentName:"p"},"module"),"\u7684\u9644\u52a0\u5c5e\u6027\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Module({\n  // imports: [ConfigModule],\n  imports: [ConfigModule.register({ url: './config', mode: 'dev' })],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n")),(0,a.kt)("p",null,"::: tip\n\u52a8\u6001\u6a21\u5757\u672c\u8eab\u53ef\u4ee5\u5bfc\u5165\u5176\u4ed6\u6a21\u5757\uff0c\u5982\u679c\u52a8\u6001\u6a21\u5757\u4f9d\u8d56\u4e8e\u5176\u4ed6\u6a21\u5757\u7684Provider\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"imports"),"\u5c5e\u6027\u5bfc\u5165\u5b83\u4eec\u3002\n:::"),(0,a.kt)("p",null,"\u5b9a\u4e49\u52a8\u6001\u6a21\u5757\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// \u6ce8\u5165\u4e24\u4e2aProvider\uff0cCONFIG_OPTIONS\u548cConfigService\n@Module({})\nexport class ConfigModule {\n  // \u8c03\u7528register\u9759\u6001\u65b9\u6cd5\uff0c\u5b9e\u73b0\u6a21\u5757\u52a8\u6001\u6ce8\u518c\n  static register(options: IOption): DynamicModule {\n    return {\n      module: ConfigModule,\n      providers: [\n        {\n          provide: 'CONFIG_OPTIONS',\n          useValue: options,\n        },\n        ConfigService,\n      ],\n      controllers: [ConfigController],\n      exports: [ConfigService],\n    };\n  }\n}\n")),(0,a.kt)("p",null,"\u5728Service\u548cController\u4e2d\u4f7f\u7528\u6ce8\u5165\u7684Provider\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class ConfigService {\n  private readonly envConfig: IEnvConfig;\n  // Service\u4e2d\u6ce8\u5165CONFIG_OPTIONS\n  constructor(@Inject('CONFIG_OPTIONS') private options) {\n    this.envConfig = {\n      author: 'Nahida',\n      timeCtl: `${new Date().getHours()}-${new Date().getMinutes()}-${new Date().getSeconds()}`,\n      options,\n    };\n  }\n  get(key: string): string {\n    return this.envConfig[key];\n  }\n  getAll() {\n    return this.envConfig;\n  }\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Controller('config')\nexport class ConfigController {\n  // Controller\u4e2d\u6ce8\u5165ConfigService\n  constructor(private configService: ConfigService) {}\n  @Get()\n  getConfig() {\n    return JSON.stringify(this.configService.getAll());\n  }\n}\n")),(0,a.kt)("h2",{id:"\u6ce8\u5165\u4f5c\u7528\u57df"},"\u6ce8\u5165\u4f5c\u7528\u57df"),(0,a.kt)("h3",{id:"provider\u8303\u56f4"},"Provider\u8303\u56f4"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u6a21\u5f0f"),(0,a.kt)("th",{parentName:"tr",align:null},"\u8303\u56f4"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"DEFAULT"),(0,a.kt)("td",{parentName:"tr",align:null},"\u6bcf\u4e2aProvider\u53ef\u4ee5\u8de8\u591a\u4e2a\u7c7b\u5171\u4eab\uff0c\u751f\u547d\u5468\u671f\u4e25\u683c\u7ed1\u5b9a\u5230\u5e94\u7528\u7a0b\u5e8f\u751f\u547d\u5468\u671f\uff0c\u4e00\u65e6\u5e94\u7528\u7a0b\u5e8f\u542f\u52a8\uff0c\u6240\u6709Provider\u90fd\u5df2\u5b9e\u4f8b\u5316\uff0c",(0,a.kt)("strong",{parentName:"td"},"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528\u5355\u4f8b\u8303\u56f4"),"\u3002")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"REQUEST"),(0,a.kt)("td",{parentName:"tr",align:null},"\u5728\u8bf7\u6c42\u5904\u7406\u5b8c\u6210\u540e\uff0c\u5c06\u4e3a\u6bcf\u4e2a\u4f20\u5165\u8bf7\u6c42\u6216\u5783\u573e\u6536\u96c6\u4e13\u95e8\u521b\u5efaProvider\u7684\u65b0\u5b9e\u4f8b")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"TRANSIENT"),(0,a.kt)("td",{parentName:"tr",align:null},"\u4e34\u65f6Provider\u4e0d\u80fd\u5728Provider\u4e4b\u95f4\u5171\u4eab\uff0c\u5f53\u5411\u5bb9\u5668\u8bf7\u6c42\u7279\u5b9a\u7684\u4e34\u65f6Provider\u65f6\uff0c\u8be5\u5bb9\u5668\u4f1a\u521b\u5efa\u4e00\u4e2a\u4e13\u7528\u7684\u5b9e\u4f8b")))),(0,a.kt)("p",null,"\u901a\u8fc7\u5411",(0,a.kt)("inlineCode",{parentName:"p"},"@Injectable()"),"\u88c5\u9970\u5668\u4f20\u9012",(0,a.kt)("inlineCode",{parentName:"p"},"scope"),"\u9009\u9879\u6765\u5207\u6362\u6ce8\u5165\u8303\u56f4\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"import { Injectable, Scope } from '@nestjs/common';\n@Injectable({ scope: Scope.REQUEST })\nexport class CatsService {}\n")),(0,a.kt)("p",null,"::: danger\n\u6ce8\u610f\uff1a\u5fc5\u987b\u975e\u5e38\u8c28\u614e\u4f7f\u7528\u8303\u56f4\u9650\u5236\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"scope"),"\u5176\u5b9e\u662f\u5728\u6ce8\u5165\u94fe\u4e2d\u5192\u6ce1\u7684\u3002\u6bd4\u5982\u6ce8\u5165\u94fe\uff1a",(0,a.kt)("inlineCode",{parentName:"p"},"CatsController <- CatsService <- CatsRepository"),"\uff0c\u5982\u679cCatsService\u662f\u8bf7\u6c42\u8303\u56f4\u7684\uff0c\u90a3\u4e48CatsController\u4e5f\u4f1a\u6210\u4e3a\u8bf7\u6c42\u8303\u56f4\uff0c\u800cCatsRepository\u4f9d\u7136\u662f\u5355\u4f8b\u7684\u3002"),(0,a.kt)("p",null,"\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5faa\u73af\u4f9d\u8d56\u5173\u7cfb\u4f1a\u5bfc\u81f4\u975e\u5e38\u75db\u82e6\u7684\u526f\u4f5c\u7528\uff0c\u5fc5\u987b\u8981\u5c3d\u53ef\u80fd\u7684\u907f\u514d\u521b\u5efa\u5b83\u4eec\u3002\n:::"),(0,a.kt)("h3",{id:"controller\u8303\u56f4"},"Controller\u8303\u56f4"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Controller({\n  path: 'cats',\n  scope: Scope.REQUEST,\n})\nexport class CatsController {}\n")),(0,a.kt)("p",null,"\u5728HTTP\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u5f53\u4f7f\u7528\u8bf7\u6c42\u8303\u56f4\u63d0\u4f9b\u8005\uff0c\u53ef\u80fd\u9700\u8981\u83b7\u53d6\u539f\u59cb\u7684\u8bf7\u6c42\u5bf9\u8c61\uff0c\u8fd9\u9700\u8981\u901a\u8fc7\u6ce8\u5165REQUEST\u5bf9\u8c61\u5b9e\u73b0\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"import { Injectable, Scope, Inject } from '@nestjs/common';\nimport { REQUEST } from '@nestjs/core';\nimport { Request } from 'express';\n@Injectable({ scope: Scope.REQUEST })\nexport class CatsService {\n  constructor(@Inject(REQUEST) private readonly request: Request) {}\n}\n")),(0,a.kt)("h2",{id:"\u5faa\u73af\u4f9d\u8d56"},"\u5faa\u73af\u4f9d\u8d56"),(0,a.kt)("p",null,"\u4e24\u4e2a\u7c7b\u4e92\u76f8\u4f9d\u8d56\u5c31\u4f1a\u51fa\u73b0\u5faa\u73af\u4f9d\u8d56\uff0c\u5efa\u8bae\u5c3d\u53ef\u80fd\u907f\u514d\u5faa\u73af\u4f9d\u8d56\uff0c\u5982\u679c\u96be\u4ee5\u907f\u514d\uff0cNest.js\u63d0\u4f9b\u4e86",(0,a.kt)("strong",{parentName:"p"},"\u524d\u5411\u5f15\u7528\u548c\u4f7f\u7528ModuleRef\u7c7b"),"\u4e24\u79cd\u6280\u672f\u6765\u4ece\u6ce8\u5165\u5bb9\u5668\u4e2d\u83b7\u53d6\u4e00\u4e2aProvider\u3002"),(0,a.kt)("h3",{id:"\u524d\u5411\u5f15\u7528"},"\u524d\u5411\u5f15\u7528"),(0,a.kt)("p",null,"\u524d\u5411\u5f15\u7528\u5141\u8bb8Nest.js\u5f15\u7528\u672a\u5b9a\u4e49\u7684\u5f15\u7528\uff0c\u5f53\u4e24\u4e2a\u7c7b\u76f8\u4e92\u4f9d\u8d56\u65f6\uff0c\u53cc\u65b9\u90fd\u9700\u8981\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"@Inject()"),"\u548c",(0,a.kt)("inlineCode",{parentName:"p"},"forwardRef()"),"\uff0c\u5426\u5219Nest.js\u4e0d\u4f1a\u5b9e\u4f8b\u5316\u5b83\u4eec\uff0c\u56e0\u4e3a\u6240\u6709\u57fa\u672c\u5143\u6570\u636e\u90fd\u4e0d\u53ef\u7528\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class CatsService {\n  constructor(\n    @Inject(forwardRef(() => CommonService))\n    private readonly commonService: CommonService,\n  ) {}\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class CommonService {\n  constructor(\n    @Inject(forwardRef(() => CatsService))\n    private readonly catsService: CatsService,\n  ) {}\n}\n")),(0,a.kt)("p",null,"\u5982\u679c\u662f\u6a21\u5757\uff0c\u524d\u5411\u5f15\u7528\u53ef\u4ee5\u8fd9\u6837\u5199\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Module({\n  imports: [forwardRef(() => CatsModule)],\n})\nexport class CommonModule {}\n")),(0,a.kt)("h3",{id:"\u4f7f\u7528moduleref\u7c7b"},"\u4f7f\u7528ModuleRef\u7c7b"),(0,a.kt)("p",null,"\u53ef\u4ee5\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"MuduleRef"),"\u7c7b\u578b\u5728\u5faa\u73af\u5173\u7cfb\u4e00\u5c42\u68c0\u7d22Provider\u3002"),(0,a.kt)("h2",{id:"\u6a21\u5757\u5f15\u7528"},"\u6a21\u5757\u5f15\u7528"),(0,a.kt)("h3",{id:"moduleref\u57fa\u672c\u4f7f\u7528"},"ModuleRef\u57fa\u672c\u4f7f\u7528"),(0,a.kt)("p",null,"Nest.js\u63d0\u4f9b\u4e86",(0,a.kt)("inlineCode",{parentName:"p"},"ModuleRef"),"\u7c7b\u6765\u5bfc\u822a\u5230\u5185\u90e8Provider\u5217\u8868\uff0c\u5e76\u4f7f\u7528\u6ce8\u5165\u4ee4\u724c\u4f5c\u4e3a\u67e5\u627e\u952e\u540d\u6765\u83b7\u53d6\u5f15\u7528\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"ModuleRef"),"\u7c7b\u4e5f\u63d0\u4f9b\u4e86\u4e00\u79cd\u52a8\u6001\u5b9e\u4f8b\u5316\u9759\u6001\u548c\u4f5c\u7528\u57dfProvider\uff0c\u53ef\u4ee5\u4ee5\u6b63\u5e38\u65b9\u5f0f\u6ce8\u5165\u5230\u7c7b\u4e2d\u3002"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"ModuleRef"),"\u5b9e\u4f8b\u62e5\u6709",(0,a.kt)("inlineCode",{parentName:"p"},"get()"),"\u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u83b7\u53d6\u4e00\u4e2a\u6ce8\u5165\u5230\u5bb9\u5668\u7684Provider\u3001Controller\u6216Injectable\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class ConfigService implements OnModuleInit {\n  private catsService: CatsService;\n  constructor(private moduleRef: ModuleRef) {}\n  onModuleInit() {\n    this.catsService = this.moduleRef.get(CatsService);\n  }\n}\n")),(0,a.kt)("p",null,"::: tip\n\u8981\u4ece\u5168\u5c40\u4e0a\u4e0b\u6587\u83b7\u53d6\u4e00\u4e2aProvider\uff0c\u5411",(0,a.kt)("inlineCode",{parentName:"p"},"get()"),"\u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4f20\u9012",(0,a.kt)("inlineCode",{parentName:"p"},"{ strict: false }"),"\u9009\u9879\u3002\n:::"),(0,a.kt)("p",null,"\u5982\u679c\u8981\u52a8\u6001\u5904\u7406\u8303\u56f4Provider\uff0c\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"resolve()"),"\u65b9\u6cd5\uff0c\u4f20\u5165\u6ce8\u5165\u4ee4\u724c\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class ConfigService implements OnModuleInit {\n  constructor(private moduleRef: ModuleRef) {}\n  async onModuleInit() {\n    // \u8981\u5728\u4e0d\u540cresolve()\u8c03\u7528\u4e4b\u95f4\u4ea7\u751f\u5355\u4f8b\u5e76\u786e\u4fdd\u5171\u4eab\u540c\u6837\u751f\u6210\u7684\u5bb9\u5668\u5b50\u6811\uff0c\u90a3\u4e48\u5c31\u8981\u50cfresolve()\u65b9\u6cd5\u4f20\u9012\u4e00\u4e2a\u4e0a\u4e0b\u6587\u5f15\u7528\n    const contextId = ContextIdFactory.create();\n    const catsServiceArr = await Promise.all([\n      this.moduleRef.resovle(CatsService, contextId);\n      this.moduleRef.resovle(CatsService, contextId);\n    ]);\n    console.log(catsServiceArr[0] === catsServiceArr[1]);   // true\n  }\n}\n")),(0,a.kt)("h3",{id:"\u6ce8\u518crequest-provider"},"\u6ce8\u518cREQUEST Provider"),(0,a.kt)("p",null,"\u901a\u8fc7",(0,a.kt)("inlineCode",{parentName:"p"},"ContextIdFactory.create()"),"\u624b\u52a8\u751f\u6210\u7684\u4e0a\u4e0b\u6587\u6807\u8bc6\u7b26\u8868\u793aID\u5b50\u6811\uff0c\u5176\u4e2dREQUEST Provider\u662f\u672a\u5b9a\u4e49\u7684\uff0c\u56e0\u4e3a\u4e0d\u662f\u7531Nest.js\u4f9d\u8d56\u6ce8\u5165\u7cfb\u7edf\u5b9e\u4f8b\u5316\u548c\u7ba1\u7406\u7684\u3002"),(0,a.kt)("p",null,"\u8981\u624b\u52a8",(0,a.kt)("strong",{parentName:"p"},"\u521b\u5efa\u7684DI\u5b50\u6811\u6ce8\u518c\u81ea\u5b9a\u4e49REQUEST\u5bf9\u8c61"),"\uff0c\u9700\u8981\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"moduleRef.registerRequestByContextId()"),"\u65b9\u6cd5\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const contextId = ContextIdFactory.create();\nthis.moduleRef.registerRequestByContextId(/* YOUR_REQUEST_OBJECT */, contextId);\n")),(0,a.kt)("h3",{id:"\u83b7\u53d6\u5f53\u524d\u5b50\u6811"},"\u83b7\u53d6\u5f53\u524d\u5b50\u6811"),(0,a.kt)("p",null,"\u6709\u65f6\uff0c\u4e5f\u9700\u8981\u5728\u8bf7\u6c42\u4e0a\u4e0b\u6587\u4e2d\u83b7\u53d6\u4e00\u4e2a\u8bf7\u6c42\u8303\u56f4\u63d0\u4f9b\u8005\u7684\u5b9e\u4f8b\u3002\u4f8b\u5982\uff0cCatsService\u662f\u8bf7\u6c42\u8303\u56f4\u7684\uff0c\u8981\u83b7\u53d6\u7684CatsRepository\u5b9e\u4f8b\u4e5f\u88ab\u6807\u8bc6\u4e3a\u8bf7\u6c42\u8303\u56f4\u3002\u8981\u5206\u4eab\u540c\u4e00\u4e2a\u6ce8\u5165\u5bb9\u5668\u5b50\u6811\uff0c\u4f60\u9700\u8981\u83b7\u53d6\u5f53\u524d\u4e0a\u4e0b\u6587\u5f15\u7528\u800c\u4e0d\u662f\u751f\u6210\u4e00\u4e2a\u65b0\u7684\uff08\u50cf\u524d\u9762\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"ContextIdFactory.create()"),"\u51fd\u6570\uff09\u3002\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"@Inject()"),"\u6765\u83b7\u53d6\u5f53\u524d\u7684\u8bf7\u6c42\u5bf9\u8c61\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class CatsService {\n  constructor(\n    @Inject(REQUEST) private request: Record<string, unknown>,\n  ) {}\n}\n")),(0,a.kt)("p",null,"\u4f7f\u7528ContextIdFactory\u7c7b\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"getByRequest()"),"\u65b9\u6cd5\u6765\u57fa\u4e8e\u8bf7\u6c42\u5bf9\u8c61\u521b\u5efa\u4e00\u4e2a\u4e0a\u4e0b\u6587id\u5e76\u4f20\u9012",(0,a.kt)("inlineCode",{parentName:"p"},"resolve()"),"\u8c03\u7528\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const contextId = ContextIdFactory.getByRequest(this.request);\nconst catsRepository = await this.moduleRef.resolve(CatsRepository, contextId);\n")),(0,a.kt)("h3",{id:"\u52a8\u6001\u5b9e\u4f8b\u5316\u81ea\u5b9a\u4e49\u7c7b"},"\u52a8\u6001\u5b9e\u4f8b\u5316\u81ea\u5b9a\u4e49\u7c7b"),(0,a.kt)("p",null,"\u8981\u52a8\u6001\u5b9e\u4f8b\u5316\u4e00\u4e2a\u4e4b\u524d\u672a\u6ce8\u518c\u7684\u7c7b\u4f5c\u4e3a\u63d0\u4f9b\u8005\uff0c\u4f7f\u7528\u6a21\u5757\u5f15\u7528\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"create()"),"\u65b9\u6cd5\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class CatsService implements OnModuleInit {\n  private catsFactory: CatsFactory;\n  constructor(private moduleRef: ModuleRef) {}\n\n  async onModuleInit() {\n    this.catsFactory = await this.moduleRef.create(CatsFactory);\n  }\n}\n")),(0,a.kt)("h2",{id:"\u6a21\u5757\u61d2\u52a0\u8f7d"},"\u6a21\u5757\u61d2\u52a0\u8f7d"),(0,a.kt)("p",null,"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6a21\u5757\u662f\u9884\u52a0\u8f7d\u7684\uff0c\u8fd9\u610f\u5473\u7740\u4e00\u65e6\u5e94\u7528\u7a0b\u5e8f\u52a0\u8f7d\uff0c\u6240\u6709\u6a21\u5757\u4e5f\u4f1a\u52a0\u8f7d\uff0c\u65e0\u8bba\u5b83\u4eec\u662f\u5426\u7acb\u5373\u9700\u8981\u3002\u867d\u7136\u5bf9\u7edd\u5927\u591a\u6570\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\u5f88\u597d\uff0c\u4f46\u5b83\u53ef\u80fd\u5728serverless\u4e2d\u8fd0\u884c\u7684apps\u548cworkers\u662f\u4e2a\u74f6\u9888\uff0c\u61d2\u52a0\u8f7d\u80fd\u901a\u8fc7\u52a0\u8f7d\u7279\u5b9a\u9700\u8981\u7684\u6a21\u5757\u6765\u51cf\u5c11\u5f15\u5bfc\u65f6\u95f4\u3002"),(0,a.kt)("p",null,"::: warning\n\u6ce8\u610f\uff1a\u61d2\u52a0\u8f7d\u7684\u6a21\u5757\u548c\u670d\u52a1\u4e0d\u4f1a\u8c03\u7528\u751f\u547d\u5468\u671f\u94a9\u5b50\u65b9\u6cd5\u3002\n:::"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"import { LazyModuleLoader } from '@nestjs/core';\n@Injectable()\nexport class LazyService {\n  constructor(private readonly lazyModuleLoader: LazyModuleLoader) {}\n  async getModule() {\n    const { LazyModule } = await import('./lazy.module');\n    const moduleRef = await this.lazyModuleLoader.load(() => LazyModule);\n    return moduleRef;\n  }\n}\n")),(0,a.kt)("p",null,"\u5982\u679c\u60f3\u5168\u5c40\u4f7f\u7528LazyModuleLoader\uff0c\u53ef\u4ee5\u8fd9\u6837\u5199\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const lazyModuleLoader = app.get(LazyModuleLoader);\n")),(0,a.kt)("p",null,"::: danger\n\u7531\u4e8eNest.js\u4e2d\u7684Controller\u8868\u793a\u8def\u7531/\u8def\u5f84/\u67e5\u8be2\u7684\u96c6\u5408\uff0c\u56e0\u6b64\u4e0d\u80fd\u4f7f\u7528LazyModuleLoader\u7c7b\u5ef6\u8fdf\u52a0\u8f7d\u5b83\u4eec\u3002\n:::"),(0,a.kt)("h2",{id:"\u6267\u884c\u4e0a\u4e0b\u6587"},"\u6267\u884c\u4e0a\u4e0b\u6587"),(0,a.kt)("h3",{id:"argumentshost"},"ArgumentsHost"),(0,a.kt)("p",null,"ArgumentsHost\u7c7b\u8e44\u51bb\u4f20\u9012\u7ed9\u5904\u7406\u7a0b\u5e8f\u7684\u53c2\u6570\uff0c\u8fd0\u884c\u9009\u62e9\u5408\u9002\u7684\u4e0a\u4e0b\u6587\uff08\u5982HTTP\u3001RPC\u3001WebSockets\uff09\u6765\u4ece\u6846\u67b6\u4e2d\u83b7\u53d6\u53c2\u6570\u3002\u4f5c\u4e3a",(0,a.kt)("inlineCode",{parentName:"p"},"host"),"\u53c2\u6570\u63d0\u4f9b\u7ed9\u9700\u8981\u83b7\u53d6\u7684\u5730\u65b9\u3002"),(0,a.kt)("p",null,"ArgumentsHost\u7b80\u5355\u5730\u62bd\u8c61\u4e3a\u5904\u7406\u7a0b\u5e8f\u53c2\u6570\u3002\u4f8b\u5982\u5728HTTP\u5e94\u7528\u4e2d\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"host"),"\u5bf9\u8c61\u5c01\u88c5\u4e86Express\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"[request, response, next]"),"\u6570\u7ec4\uff1b\u5728GraphQL\u5e94\u7528\u4e2d\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"host"),"\u5305\u542b",(0,a.kt)("inlineCode",{parentName:"p"},"[root, args, context, info]"),"\u6570\u7ec4\u3002"),(0,a.kt)("p",null,"1.\u53ef\u4ee5\u901a\u8fc7",(0,a.kt)("inlineCode",{parentName:"p"},"getType()"),"\u65b9\u6cd5\u6765\u533a\u5206\u5f53\u524d\u5e94\u7528\u7684\u4e0a\u4e0b\u6587\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"if (host.getType() === 'http') {\n  // do something that is only important in the context of regular HTTP requests (REST)\n} else if (host.getType() === 'rpc') {\n  // do something that is only important in the context of Microservice requests\n} else if (host.getType<GqlContextType>() === 'graphql') {\n  // do something that is only important in the context of GraphQL requests\n}\n")),(0,a.kt)("p",null,"2.\u53ef\u4ee5\u901a\u8fc7",(0,a.kt)("inlineCode",{parentName:"p"},"host"),"\u5bf9\u8c61\u7684",(0,a.kt)("inlineCode",{parentName:"p"},"getArgs()"),"\u65b9\u6cd5\u83b7\u53d6\u4f20\u9012\u7ed9\u7a0b\u5e8f\u7684\u53c2\u6570\u6570\u7ec4\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const [req, res, next] = host.getArgs();\n")),(0,a.kt)("p",null,"3.\u4e3a\u4e86\u4f7f\u4ee3\u7801\u66f4\u5065\u58ee\u548c\u53ef\u590d\u7528\uff0c\u53ef\u4ee5\u901a\u8fc7",(0,a.kt)("inlineCode",{parentName:"p"},"host"),"\u7684\u5e94\u7528\u65b9\u6cd5\u6765\u5207\u6362\u5408\u9002\u7684\u4e0a\u4e0b\u6587\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// Switch context to RPC\nswitchToRpc(): RpcArgumentsHost;\n// Switch context to HTTP\nswitchToHttp(): HttpArgumentsHost;\n// Switch context to WebSockets\nswitchToWs(): WsArgumentsHost;\n")),(0,a.kt)("p",null,"\u8fd9\u6837\u4e0a\u9762\u4ee3\u7801\u53ef\u4ee5\u4f18\u5316\u4e3a\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const ctx = host.switchToHttp();\nconst request = ctx.getRequest<Request>();\nconst response = ctx.getResponse<Response>();\n")),(0,a.kt)("p",null,"\u5982\u679c\u662fRPC\uff0c\u53ef\u4ee5\u8fd9\u6837\u5199\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const ctx = host.switchToRpc();\nconst data = ctx.getData();\nconst client = ctx.getClient();\n")),(0,a.kt)("h3",{id:"executioncontext"},"ExecutionContext"),(0,a.kt)("p",null,"ExecutionContext\u6269\u5c55\u4e86ArgumentsHost\uff0c\u63d0\u4f9b\u989d\u5916\u7684\u5f53\u524d\u8fd0\u884c\u7ebf\u7a0b\u4fe1\u606f\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export interface ExecutionContext extends ArgumentsHost {\n  // \u8fd4\u56de\u5f53\u524d\u5904\u7406\u7a0b\u5e8f\u6240\u5c5e\u7684\u63a7\u5236\u5668\u7c7b\u7684\u7c7b\u578b\n  getClass<T = any>(): Type<T>;\n  // \u8fd4\u56de\u8981\u8c03\u7528\u7684\u5904\u7406\u7a0b\u5e8f\u7684\u5f15\u7528\n  getHandler(): Function;\n}\n")),(0,a.kt)("h3",{id:"\u53cd\u5c04\u548c\u5143\u6570\u636e"},"\u53cd\u5c04\u548c\u5143\u6570\u636e"),(0,a.kt)("p",null,"Nest.js\u63d0\u4f9b\u4e86\u901a\u8fc7",(0,a.kt)("inlineCode",{parentName:"p"},"@SetMetadata()"),"\u88c5\u9970\u5668\u5c06\u81ea\u5b9a\u4e49\u5143\u6570\u636e\u9644\u52a0\u5728\u8def\u5f84\u5904\u7406\u7a0b\u5e8f\u7684\u80fd\u529b\u3002"),(0,a.kt)("p",null,"\u4e0b\u9762\u6211\u4eec\u5c06",(0,a.kt)("inlineCode",{parentName:"p"},"roles"),"\u5143\u6570\u636e\u5173\u8054\u5230",(0,a.kt)("inlineCode",{parentName:"p"},"create()"),"\u65b9\u6cd5"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Post()\n@SetMetadata('roles', ['admin'])\nasync create(@Body() createCatDto: CreateCatDto) {\n  this.catsService.create(createCatDto);\n}\n")),(0,a.kt)("p",null,"\u8981\u60f3\u8bbf\u95ee",(0,a.kt)("inlineCode",{parentName:"p"},"roles"),"\u81ea\u5b9a\u4e49\u5143\u6570\u636e\uff0c\u8981\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"Reflector"),"\u7c7b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"// \u8bfb\u53d6\u5904\u7406\u7a0b\u5e8f\u7684\u5143\u6570\u636e\nconst roles = this.reflector.get<string[]>('roles', context.getHandler());\n// \u8bfb\u53d6\u63a7\u5236\u5668\u5143\u6570\u636e\nconst roles = this.reflector.get<string[]>('roles', context.getClass());\n")),(0,a.kt)("p",null,"\u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a\u4f7f\u7528\u53cd\u5c04\u7684\u4f8b\u5b50\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class AuthGuard implements CanActivate {\n  constructor(private reflector: Reflector) {}\n  canActivate(\n    context: ExecutionContext,\n  ): boolean | Promise<boolean> | Observable<boolean> {\n    const roles = this.reflector.get<string[]>('roles', context.getClass());\n    // \u5f53\u8bbf\u95eeGET /cats\u65f6\u5019\uff0c\u6253\u5370['admin']\n    console.log(roles);\n    return true;\n  }\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Controller('cats')\n@UseGuards(AuthGuard)\n@SetMetadata('roles', ['admin'])\nexport class CatsController {\n  constructor(private catsService: CatsService) {}\n  @Get()\n  async findAll() {\n    return this.catsService.findAll();\n  }\n}\n")),(0,a.kt)("p",null,"\u5982\u679c\u5728\u4e24\u4e2a\u6c34\u5e73\u5e94\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"roles"),"\u5143\u6570\u636e\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@SetMetadata('roles', ['user'])\n@Controller('cats')\nexport class CatsController {\n  constructor(private catsService: CatsService) {}\n  @Get()\n  @SetMetadata('roles', ['admin'])\n  async findAll() {\n    return this.catsService.findAll();\n  }\n}\n")),(0,a.kt)("p",null,"\u90a3\u4e48\u53ef\u4ee5\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"getAllAndOverride()"),"\u6709\u9009\u62e9\u7684\u8fdb\u884c\u8986\u76d6\uff0c\u6216\u8005\u4f7f\u7528",(0,a.kt)("inlineCode",{parentName:"p"},"getAllAndMerge()"),"\u5408\u5e76\u5143\u6570\u636e\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"const roles = this.reflector.getAllAndMerge<string[]>('roles', [\n  context.getHandler(),\n  context.getClass(),\n]);\n")),(0,a.kt)("h2",{id:"\u751f\u547d\u5468\u671f\u4e8b\u4ef6"},"\u751f\u547d\u5468\u671f\u4e8b\u4ef6"),(0,a.kt)("h3",{id:"\u6267\u884c\u987a\u5e8f"},"\u6267\u884c\u987a\u5e8f"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(5735).Z,width:"858",height:"722"})),(0,a.kt)("h3",{id:"\u4f7f\u7528"},"\u4f7f\u7528"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u751f\u547d\u5468\u671f\u94a9\u5b50\u65b9\u6cd5"),(0,a.kt)("th",{parentName:"tr",align:null},"\u751f\u547d\u5468\u671f\u4e8b\u4ef6\u89e6\u53d1\u94a9\u5b50\u65b9\u6cd5\u8c03\u7528"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"OnModuleInit()")),(0,a.kt)("td",{parentName:"tr",align:null},"\u4e3b\u6a21\u5757\u4f9d\u8d56resolved\u540e\u8c03\u7528\u4e00\u6b21")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"OnApplicationBootstrap()")),(0,a.kt)("td",{parentName:"tr",align:null},"\u5728\u5e94\u7528\u7a0b\u5e8f\u5b8c\u5168\u542f\u52a8\u5e76\u76d1\u542c\u8fde\u63a5\u540e\u8c03\u7528\u4e00\u6b21")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"OnModuleDestroy()")),(0,a.kt)("td",{parentName:"tr",align:null},"\u6536\u5230\u7ec8\u6b62\u4fe1\u53f7\u540e\u8c03\u7528")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"beforeApplicationShutdown()")),(0,a.kt)("td",{parentName:"tr",align:null},"\u5728\u6240\u6709",(0,a.kt)("inlineCode",{parentName:"td"},"onModuleDestory()"),"\u5b8c\u6210\u540e\u8c03\u7528\uff1b\u4e00\u65e6\u5b8c\u6210\uff0c\u6240\u6709\u5b58\u5728\u8fde\u63a5\u5c06\u4f1a\u5173\u95ed")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},(0,a.kt)("inlineCode",{parentName:"td"},"OnApplicationShutdown()")),(0,a.kt)("td",{parentName:"tr",align:null},"\u8fde\u63a5\u5173\u95ed\u5904\u7406\u65f6\u8c03\u7528")))),(0,a.kt)("p",null,"::: danger\n\u4e0a\u8ff0\u5217\u51fa\u7684\u751f\u547d\u5468\u671f\u94a9\u5b50\u6ca1\u6709\u88ab\u8bf7\u6c42\u8303\u56f4\u7c7b\u89e6\u53d1\u3002\u8bf7\u6c42\u8303\u56f4\u7c7b\u5e76\u6ca1\u6709\u548c\u751f\u547d\u5468\u671f\u4ee5\u53ca\u4e0d\u53ef\u9884\u6d4b\u7684\u5bff\u547d\u7ed1\u5b9a\u3002\u4ed6\u4eec\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u5355\u72ec\u521b\u5efa\uff0c\u5e76\u5728\u54cd\u5e94\u53d1\u9001\u540e\u901a\u8fc7\u5783\u573e\u6e05\u7406\u7cfb\u7edf\u81ea\u52a8\u6e05\u7406\u3002\n:::"),(0,a.kt)("p",null,"\u4f7f\u7528\uff0c\u5b9e\u73b0\u5bf9\u5e94\u94a9\u5b50\u7684\u63a5\u53e3\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"@Injectable()\nexport class UsersService implements OnModuleInit {\n  onModuleInit(): Promise<void> {\n    await this.fetch();\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"onModuleDestroy()"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"beforeApplicationShutdown()"),"\u548c",(0,a.kt)("inlineCode",{parentName:"p"},"onApplicationShutdown()"),"\u94a9\u5b50\u7a0b\u5e8f\u54cd\u5e94\u7cfb\u7edf\u7ec8\u6b62\u4fe1\u53f7\u5173\u95ed\u94a9\u5b50\u6d88\u8017\u7cfb\u7edf\u8d44\u6e90\uff0c\u56e0\u6b64\u9ed8\u8ba4\u662f\u7981\u7528\u7684\uff0c\u8981\u4f7f\u7528\u5fc5\u987b\u901a\u8fc7",(0,a.kt)("inlineCode",{parentName:"p"},"enableShutdownHooks()"),"\u6fc0\u6d3b\u4fa6\u542c\u5668\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts{3}"},"async function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n  app.enableShutdownHooks();\n  await app.listen(3000);\n}\n")),(0,a.kt)("p",null,"::: warning\n",(0,a.kt)("inlineCode",{parentName:"p"},"enableShutdownHooks"),"\u5f00\u59cb\u76d1\u542c\u65f6\u6d88\u8017\u5185\u5b58\uff0c\u5982\u679c\u8981\u5728\u4e00\u4e2a\u5355\u72ecNode\u7ebf\u7a0b\u4e2d\u8fd0\u884c\u591a\u4e2aNest\u5e94\u7528\uff08\u4f8b\u5982\uff0c\u4f7f\u7528\u591a\u4e2aJest\u8fd0\u884c\u6d4b\u8bd5\uff09\uff0cNode\u4f1a\u62b1\u6028\u76d1\u542c\u8005\u592a\u591a\u3002\u51fa\u4e8e\u8fd9\u4e2a\u539f\u56e0",(0,a.kt)("inlineCode",{parentName:"p"},"enableShutdownHooks"),"\u9ed8\u8ba4\u672a\u542f\u7528\uff0c\u8981\u5728\u5355\u4e2aNode\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u591a\u4e2a\u5b9e\u4f8b\u65f6\u5c24\u5176\u8981\u6ce8\u610f\u8fd9\u4e00\u70b9\u3002\n:::"))}u.isMDXComponent=!0},5735:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/lifecycle-events-8397b3033414c360a0ad255038927b1a.png"}}]);